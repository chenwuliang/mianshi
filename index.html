<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Upload Data</title>
    <link rel="stylesheet" href="assets/lib/layui/css/layui.css" />
    <link rel="stylesheet" href="assets/css/base.css" />
  </head>
  <body>
    <button
      class="layui-btn run-task-upload"
      lay-submit
      lay-filter="formDemo"
      style="float: right"
    >
      开启新任务上传
    </button>
    <button
      class="layui-btn upload-assets"
      lay-submit
      lay-filter="formDemo"
      style="float: right"
    >
      上传全部任务结果
    </button>
    <button
      class="layui-btn pull-tasks"
      lay-submit
      lay-filter="formDemo"
      style="float: right"
    >
      从云端拉取任务
    </button>
    <input type="file" id="file" onchange="handleFiles(this.files)" />
    <button
      class="layui-btn file-tasks"
      lay-submit
      lay-filter="formDemo"
      style="float: right"
    >
      从文件读取任务
    </button>
    <p id="text"></p>

    <script src="assets/js/jquery-3.3.1.min.js"></script>
    <script src="assets/js/json2csv.js"></script>
    <script src="assets/lib/layui/layui.all.js"></script>

    <script>
      let autoUpload = false;
      let goby = parent.goby; // 获取GobyAPi
      let load;
      let all_task_info;
      function handleFiles(files) {
        document.getElementById("text").innerHTML = "";
        all_task_info = [];
        if (files.length) {
          let file = files[0];
          let reader = new FileReader();
          reader.onload = function () {
            document.getElementById("text").innerHTML = this.result;
            all_task_info = JSON.parse(this.result);
          };

          reader.readAsText(file);
        }
      }
      $(".upload-assets").on("click", function () {
        load = layer.load();
        parent.getTasksList(getTasksListCb);
      });
      $(".run-task-upload").on("click", function () {
        autoUpload = !autoUpload;
        console.log("新任务上传: ", autoUpload);
        if (autoUpload) {
          goby.showInformationMessage("开启新任务上传");
          document.querySelector(".run-task-upload").innerHTML =
            "关闭新任务上传";
        } else {
          goby.showInformationMessage("关闭新任务上传");
          document.querySelector(".run-task-upload").innerHTML =
            "开启新任务上传";
        }
      });
      // 回调函数
      function getAssetCb(data) {
        if (data.statusCode == 200) {
          if (data.data.ips) {
            console.log(data.data);
            $.ajax({
              url: "https://114.67.109.134:9523/savedb/assets",
              type: "POST",
              dataType: "json",
              timeout: 10000,
              data: JSON.stringify(data.data),
              headers: {
                Authorization: "Basic enZkdzM6Mzh6aFZTemQ=",
                "Content-Type": "application/json",
              },
              success: function (res) {
                console.log(res);
                goby.showInformationMessage("上传成功");
              },
              error: function (res) {
                console.log(res);
                goby.showErrorMessage("上传失败,请联系人工处理");
              },
            });
          } else {
            goby.showInformationMessage("无数据");
          }
        } else {
          goby.showErrorMessage(data.messages);
        }
      }
      function getTasksListCb(data) {
        if (data.statusCode == 200) {
          console.log(data.data);
          tlist = data.data.lists;
          for (var i = 0; i < tlist.length; i++) {
            console.log("tlist[i]", tlist[i]);
            $.ajax({
              url: "https://114.67.109.134:9523/savedb/tasks",
              type: "POST",
              dataType: "json",
              timeout: 10000,
              data: JSON.stringify(tlist[i]),
              headers: {
                Authorization: "Basic enZkdzM6Mzh6aFZTemQ=",
                "Content-Type": "application/json",
              },
              success: function (res) {
                console.log(res);
                goby.showInformationMessage("上传成功");
              },
              error: function (res) {
                console.log(res);
                goby.showErrorMessage("上传失败,请联系人工处理");
              },
            });
            goby.getAsset(tlist[i].taskId, getAssetCb);
          }
        } else {
          goby.showErrorMessage("没有扫描任务");
        }
        layer.close(load);
      }
      goby.bindEvent("onEndScan", (content) => {
        console.log("扫描完成: ", content.taskId, content.taskName);
        if (autoUpload) {
          console.log("开始上传扫描结果: ", content.taskId);
          goby.getAsset(content.taskId, getAssetCb);
        }
      });

      $(".pull-tasks").on("click", function () {
        goby.showInformationMessage("当前功能还为开发完成");
      });

      $(".file-tasks").on("click", function () {
        all_task_info.forEach(function (item) {
          console.log(item);

          gs = goby.startScan(item);
          gs.then(function (res) {
            console.log(res);
          }).catch(function (error) {
            console.log(error);
          });

          console.log(goby.getScanState().state);
          console.log("goby startScan over");
        });
      });
    </script>
  </body>
</html>
